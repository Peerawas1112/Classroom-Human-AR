<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Human Anatomy AR Learning</title>

<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Kanit,sans-serif;
  background:#020617;
  color:white;
}
.home,.quiz-page{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#020617;
  z-index:10;
}
.quiz-page{display:none;}
.box{
  width:90%;
  max-width:480px;
  background:#0f172a;
  border-radius:20px;
  padding:24px;
  text-align:center;
}
button{
  padding:12px 18px;
  border:none;
  border-radius:14px;
  background:#ff4757;
  color:white;
  cursor:pointer;
}
.choice{
  background:#1e293b;
  padding:12px;
  border-radius:12px;
  margin:8px 0;
  cursor:pointer;
}
.choice.correct{background:#16a34a;}
.choice.wrong{background:#dc2626;}
.tabs,.menu{
  display:flex;
  gap:8px;
  padding:10px;
  overflow-x:auto;
}
.tab-btn,.menu-item{
  padding:8px 14px;
  border-radius:14px;
  background:#1e293b;
  cursor:pointer;
}
.tab-btn.active,.menu-item.active{background:#ff4757;}
.main{height:calc(100vh - 110px);}
model-viewer{width:100%;height:100%;}
.info-panel{
  position:absolute;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  background:#0f172a;
  width:90%;
  max-width:420px;
  border-radius:16px;
  padding:14px;
}
button:disabled { background: #475569; cursor: not-allowed; }
  .summary-score { font-size: 2.5rem; color: #ff4757; margin: 15px 0; font-weight: bold; }
  .explanation { font-size: 0.9rem; color: #cbd5e1; margin-top: 10px; font-style: italic; }
  /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ */
  .timer-container {
    width: 100%;
    height: 8px;
    background: #1e293b;
    border-radius: 4px;
    margin: 15px 0;
    overflow: hidden;
  }
  #timerBar {
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #ff4757, #ff6b81);
    transition: width 1s linear;
  }
  .timer-text { font-size: 0.9rem; color: #ff4757; font-weight: bold; }
</style>
</head>

<body>

<div id="home" class="home">
  <div class="box">
    <h1>Human Anatomy AR</h1>
    <button onclick="startLearning()">üìö ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button><br><br>
    <button onclick="openQuiz()">üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button><br><br>
    <button onclick="openQuiz()">üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  </div>
</div>

<div id="quizPage" class="quiz-page">
  <div class="box">
    <div class="timer-text">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="timeLeft">15</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
    <div class="timer-container"><div id="timerBar"></div></div>
    
    <h2 id="qTitle"></h2>
    <div id="qChoices"></div>
    <p id="qProgress"></p>
    <button id="nextBtn" onclick="nextQuestion()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button><br><br>
    <button onclick="closeQuiz()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>
</div>

<div class="tabs" id="tabs"></div>

<div class="main">
  <model-viewer id="viewer"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    auto-rotate>
  </model-viewer>

  <div class="info-panel">
    <h3 id="title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞</h3>
    <p id="desc"></p>
  </div>

  <div class="menu" id="menu"></div>
</div>

<script>
const home=document.getElementById("home");
const quizPage=document.getElementById("quizPage");
const viewer=document.getElementById("viewer");
const tabs=document.getElementById("tabs");
const menu=document.getElementById("menu");
const title=document.getElementById("title");
const desc=document.getElementById("desc");
const qTitle=document.getElementById("qTitle");
const qChoices=document.getElementById("qChoices");
const qProgress=document.getElementById("qProgress");

let data=[], currentQuizData=[], qIndex=0, score=0, isAnswered=false;

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
fetch("anatomy_data.json")
.then(r=>r.json())
.then(j=>{
  data=j.systems;
  renderTabs();
  loadSystem(0);
});

/* --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ --- */
function startLearning(){ home.style.display="none"; }

function renderTabs(){
  tabs.innerHTML=data.map((s,i)=>
    `<div class="tab-btn" id="t${i}" onclick="loadSystem(${i})">${s.category}</div>`
  ).join("");
}

function loadSystem(i){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById("t"+i).classList.add("active");
  
  menu.innerHTML=data[i].items.map((o,j)=>
    `<div class="menu-item" id="m${i}${j}" onclick="selectOrgan(${i},${j})">${o.name}</div>`
  ).join("");
  selectOrgan(i,0);
}

function selectOrgan(i,j){
  document.querySelectorAll(".menu-item").forEach(m=>m.classList.remove("active"));
  const activeMenu = document.getElementById(`m${i}${j}`);
  if(activeMenu) activeMenu.classList.add("active");

  const o=data[i].items[j];
  viewer.src=o.model_file;
  title.textContent=o.name;
  desc.textContent=o.description;
  currentQuizData = [...o.quiz].sort(() => Math.random() - 0.5);
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Quiz
  currentQuizData = o.quiz || [];
}

/* --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö --- */
function openQuiz(){
  if(currentQuizData.length === 0){
    alert("‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
    return;
  }
  home.style.display="none";
  quizPage.style.display="flex";
  qIndex=0; score=0;
  showQuestion();
}

function showQuestion(){
  isAnswered = false;
  const btnNext = document.querySelector("button[onclick='nextQuestion()']");
  btnNext.disabled = true; // ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡∏≠‡∏ö

  if(qIndex >= currentQuizData.length){
    showResult();
    return;
  }

  const q = currentQuizData[qIndex];
  qTitle.textContent = q.question;
  qChoices.innerHTML = q.choices.map((c,i)=>
    `<div class="choice" onclick="answer(${i})">${c}</div>`
  ).join("");
  qProgress.textContent = `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${qIndex+1} ‡∏à‡∏≤‡∏Å ${currentQuizData.length}`;
}

function answer(i){
  if(isAnswered) return;
  isAnswered = true;

  const q = currentQuizData[qIndex];
  const choices = document.querySelectorAll(".choice");
  const btnNext = document.querySelector("button[onclick='nextQuestion()']");
  
  choices.forEach((c, idx) => {
    if(idx === q.answer) c.classList.add("correct");
    if(idx === i && i !== q.answer) c.classList.add("wrong");
  });

  if(i === q.answer) score++;
  btnNext.disabled = false; // ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ
}

function nextQuestion(){
  qIndex++;
  showQuestion();
}

function showResult(){
  const percent = (score / currentQuizData.length) * 100;
  let grade = "";
  if(percent >= 80) grade = "‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! üåü";
  else if(percent >= 50) grade = "‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞ üëç";
  else grade = "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞ üìö";

  qTitle.textContent = "‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";
  qChoices.innerHTML = `
    <div class="summary-score">${score} / ${currentQuizData.length}</div>
    <p style="font-size: 1.2rem;">${grade}</p>
    <button onclick="closeQuiz()" style="width:100%; margin-top:20px;">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  `;
  qProgress.textContent = "";
  document.querySelector("button[onclick='nextQuestion()']").style.display = "none";
}

function closeQuiz(){
  quizPage.style.display="none";
  home.style.display="flex";
  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
  document.querySelector("button[onclick='nextQuestion()']").style.display = "inline-block";
}
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏ß‡∏•‡∏≤
let timerInterval;
let timeLeft = 15; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
const maxTime = 15;

function showQuestion() {
  isAnswered = false;
  const btnNext = document.getElementById("nextBtn");
  btnNext.disabled = true;

  if(qIndex >= currentQuizData.length){
    clearInterval(timerInterval);
    showResult();
    return;
  }

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠
  resetTimer();

  const q = currentQuizData[qIndex];
  qTitle.textContent = q.question;
  qChoices.innerHTML = q.choices.map((c,i)=>
    `<div class="choice" onclick="answer(${i})">${c}</div>`
  ).join("");
  qProgress.textContent = `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${qIndex+1} ‡∏à‡∏≤‡∏Å ${currentQuizData.length}`;
}

function resetTimer() {
  clearInterval(timerInterval);
  timeLeft = maxTime;
  updateTimerUI();
  
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerUI();
    
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      autoAnswer(); // ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏•‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    }
  }, 1000);
}

function updateTimerUI() {
  document.getElementById("timeLeft").textContent = timeLeft;
  const widthPercent = (timeLeft / maxTime) * 100;
  document.getElementById("timerBar").style.width = widthPercent + "%";
}

function autoAnswer() {
  if (isAnswered) return;
  // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ -1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö (‡∏ú‡∏¥‡∏î)
  answer(-1); 
  alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ‚è∞");
}

function answer(i) {
  if (isAnswered) return;
  isAnswered = true;
  clearInterval(timerInterval); // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö

  const q = currentQuizData[qIndex];
  const choices = document.querySelectorAll(".choice");
  const btnNext = document.getElementById("nextBtn");
  
  choices.forEach((c, idx) => {
    if(idx === q.answer) c.classList.add("correct");
    if(idx === i && i !== q.answer) c.classList.add("wrong");
  });

  if(i === q.answer) score++;
  btnNext.disabled = false;
}

// ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏•‡πâ‡∏≤‡∏á Timer ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Quiz
function closeQuiz() {
  clearInterval(timerInterval);
  quizPage.style.display="none";
  home.style.display="flex";
  document.getElementById("nextBtn").style.display = "inline-block";
}
</script>

</body>
</html>
